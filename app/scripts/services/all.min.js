sukuApp.factory("AuthLoaderService",["$q","$http","RegisterService","NotificationService","PubSubService","Helper","Strophe","ServerFileModel",function(d,f,e,h,j,c,b,a){var g={};g.user={is_loaded:false,me:true};g.page={title:null};g.getUser=function(){var k=d.defer();if(g.user.is_connected){console.log("ton");k.resolve(g.user);return k.promise}return f.get("../server/get-user/0").then(function(l){angular.copy(l.data,g.user);g.user.me=true;g.is_connected=true;console.log("not");console.log(g.user);k.resolve(g.user);return k.promise})};g.load=function(){var l=this;var k=d.defer();return g.getUser().then(function(m){g.user.first=parseInt(g.user.first);if(l.user.is_connected){k.resolve();return k.promise}h.init(c.email2jid(g.user.email));if(g.user.first){return e.register(g.user).then(function(){g.user.is_connected=true;g.user.first=0;return j.createNode("users-"+b.getNodeFromJid(c.email2jid(g.user.email))).then(function(){h.getNotifications()})})}else{console.log(g.user);return e.connect(g.user).then(function(){h.getNotifications();g.user.is_connected=true;k.resolve();return k.promise})}})};g.invite=function(k){var l=d.defer();f.post("../server/invite-user",{email:k}).then(function(m){console.log(m.data);m=parseInt(m.data);console.log(m);if(m==1){l.resolve()}else{if(m==2){l.reject({msg:k+" is already in Sukull. If you want to share your classroom with him, open the classroom and do it there"})}else{if(m==3){l.reject({msg:k+" is no more a member of Sukull"})}else{l.reject({msg:"Unable to invite "+k+" to join Sukull"})}}}},function(m){console.log(m);l.reject(m)});return l.promise};g.editpwd=function(k,m,l){var n=d.defer();f.post("../server/change-pwd",{old:k,new1:m,new2:l}).then(function(o){o=parseInt(o.data);if(o!=1){n.reject({msg:"Unable to change the password"});return}n.resolve();return},function(o){n.reject({msg:"Unable to change the password"})});return n.promise};g.edittof=function(k,l){var m=d.defer();var k=new a({file:k,type:l});k.psave();k.save().then(function(n){self.working=false;if(n=="0"){m.reject({msg:"Error while saving the file. Check that the extension and the size are correct"});return}console.log(n);f.post("../server/change-tof",{img:n}).then(function(o){o=parseInt(o.data);if(o!=1){m.reject({msg:"Error while changing the image1"});return}m.resolve();g.user.img="imgs/"+n},function(){m.reject({msg:"Error while changing the image2"})})},function(n){m.reject({msg:"Error while changing the image3"})});return m.promise};g.disconnect=e.disconnect;window.auth=g;return g}]);sukuApp.factory("ChartDataService",["Helper",function(a){var b=Spine.Class.sub({init:function(c){this.meta=c;this.options={col_data_series:true}}});b.include({random_color:function(){return Math.round(Math.random()*256)},for_column:function(l){if(!l){l="column"}var e=this.options||{col_data_series:true};var k={labels:[]};var h;var c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";k.datasets=[];console.log(this.meta);M=this.meta;if(e.col_data_series){if(this.meta.min_col<this.meta.max_col){for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){k.labels.push(this.meta.row_headers[f])}}for(var d=this.meta.min_col+1;d<=this.meta.max_col;++d){if(this.meta.empty_cols[d]){continue}c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";h={label:this.meta.col_headers[d],fillColor:c+"0.7)",strokeColor:c+"0.4)",pointColor:c+"0.4)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:c+"0.1)",data:[]};for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){h.data.push(this.meta.data[f+"-"+d])}}k.datasets.push(h)}}else{console.log("uni-col");k.datasets=[{label:this.meta.col_headers[this.meta.min_col],fillColor:c+"0.7)",strokeColor:c+"0.4)",pointColor:c+"0.4)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:c+"0.1)",data:[]}];var g={};var h=[];for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){h.push(this.meta.data[f+"-"+this.meta.min_col])}}for(var f=0;f<h.length;++f){if(g[h[f]]){++g[h[f]]}else{k.labels.push(h[f]);g[h[f]]=1}}for(var f=0;f<k.labels.length;++f){k.datasets[0].data.push(g[k.labels[f]])}}}else{if(this.meta.min_row<this.meta.max_row||true||l=="radar"){for(var d=this.meta.min_col+1;d<=this.meta.max_col;++d){if(!this.meta.empty_cols[d]){k.labels.push(this.meta.col_headers[d])}}for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(this.meta.empty_rows[f]){continue}c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";h={label:this.meta.row_headers[f],fillColor:c+"0.7)",strokeColor:c+"0.4)",pointColor:c+"0.4)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:c+"0.1)",data:[]};for(var d=this.meta.min_col+1;d<=this.meta.max_col;++d){if(!this.meta.empty_cols[d]){h.data.push(this.meta.data[f+"-"+d])}}k.datasets.push(h)}}else{console.log("uni-col");k.datasets=[{label:this.meta.col_headers[this.meta.min_col],fillColor:c+"0.7)",strokeColor:c+"0.4)",pointColor:c+"0.4)",pointStrokeColor:"#fff",pointHighlightFill:"#fff",pointHighlightStroke:c+"0.1)",data:[]}];var g={};var h=[];for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){h.push(this.meta.data[f+"-"+this.meta.min_col])}}for(var f=0;f<h.length;++f){if(g[h[f]]){++g[h[f]]}else{k.labels.push(h[f]);g[h[f]]=1}}for(var f=0;f<k.labels.length;++f){k.datasets[0].data.push(g[k.labels[f]])}}}D=k;return k},for_bar:function(){return this.for_column("bar")},for_line:function(){return this.for_column("line")},for_pie:function(k){if(!k){waht="pie"}var m=this.options||{col_data_series:true};var e=[];var c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";if(m.col_data_series){if(this.meta.min_col<this.meta.max_col){for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";e.push({label:this.meta.data[f+"-"+this.meta.min_col],color:c+"0.7)",highlight:c+"0.4)",value:parseFloat(this.meta.data[f+"-"+this.meta.max_col])})}}}else{console.log("uni-col");var h={};var l=[];var g=[];for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){l.push(this.meta.data[f+"-"+this.meta.min_col])}}for(var f=0;f<l.length;++f){if(h[l[f]]){++h[l[f]]}else{g.push(l[f]);h[l[f]]=1}}for(var f=0;f<g.length;++f){c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";e.push({label:g[f],color:c+"0.7)",highlight:c+"0.4)",value:h[g[f]]})}}}else{if(this.meta.min_row<this.meta.max_row){for(var d=this.meta.min_col+1;d<=this.meta.max_col;++d){if(!this.meta.empty_cols[d]){c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";e.push({label:this.meta.data[this.meta.min_row+"-"+d],color:c+"0.7)",highlight:c+"0.4)",value:parseFloat(this.meta.data[this.meta.max_row+"-"+d])})}}}else{console.log("uni-col");var h={};var l=[];var g=[];for(var f=this.meta.min_row;f<=this.meta.max_row;++f){if(!this.meta.empty_rows[f]){l.push(this.meta.data[f+"-"+this.meta.min_col])}}for(var f=0;f<l.length;++f){if(h[l[f]]){++h[l[f]]}else{g.push(l[f]);h[l[f]]=1}}for(var f=0;f<g.length;++f){c="rgba("+this.random_color()+","+this.random_color()+","+this.random_color()+",";e.push({label:g[f],color:c+"0.7)",highlight:c+"0.4)",value:h[g[f]]})}}}D=e;return e},for_polar:function(){return this.for_pie("polar")},for_doughnut:function(){return this.for_pie("polar")},for_radar:function(){return this.for_column("radar")}});return b}]);sukuApp.factory("ChartViewService",["Helper","ChartDataService",function(b,c){var a=Spine.Controller.sub({init:function(){this.el.addClass("chart-dialog");this.el.find('[data-toggle="tooltip"]').tooltip();this.legend=this.el.find(".chart-main .chart-legend");DragDrop.bind(this.el[0],{anchor:this.el.find(">.dialog-header")[0]});this.el.find('a[href="#close"]').bind("click",this.proxy(this.close_hdl));this.canvas=this.el.find("canvas").get(0);this.textarea=this.el.find('textarea[name="range"]');if(this.view){this.meta=this.view.graph_selection();this.view.chart=this}else{this.textarea.attr("disabled",true)}this.regex_area=new RegExp(/([a-zA-Z]+[1-9][0-9]*:[a-zA-Z]+[1-9][0-9]*,\s*)*([a-zA-Z]+[1-9][0-9]*:[a-zA-Z]+[1-9][0-9]*)/gi);this.sregex=new RegExp(/^([a-zA-Z]+)([1-9][0-9]*):([a-zA-Z]+)([1-9][0-9]*)$/i);this.current_graph="bar";this.el.find(".tabs-view").tabs_view();this.bind_events();if(!this.meta){return}this.data=new c(this.meta);window.chart=new Chart(this.canvas.getContext("2d")).Bar(this.data.for_bar());this.textarea.val(this.meta.cells_area);this.legend.get(0).innerHTML=window.chart.generateLegend()},switch_graph:function(d){this.current_graph=d;if(window.chart){window.chart.destroy()}if(d=="column"){window.chart=new Chart(this.canvas.getContext("2d")).Bar(this.data.for_column())}else{if(d=="line"){window.chart=new Chart(this.canvas.getContext("2d")).Line(this.data.for_line())}else{if(d=="pie"){window.chart=new Chart(this.canvas.getContext("2d")).Pie(this.data.for_pie())}else{if(d=="doughnut"){window.chart=new Chart(this.canvas.getContext("2d")).Doughnut(this.data.for_doughnut())}else{if(d=="polar-area"){window.chart=new Chart(this.canvas.getContext("2d")).PolarArea(this.data.for_polar())}else{if(d=="radar"){window.chart=new Chart(this.canvas.getContext("2d")).Radar(this.data.for_radar())}else{if(d=="bar"){window.chart=new Chart(this.canvas.getContext("2d")).Bar(this.data.for_bar())}else{throw (d+": unknow graph type");return}}}}}}}this.legend.get(0).innerHTML=window.chart.generateLegend()},bind_events:function(){var d=this;this.el.find('.chart-left div[what="type"] img[graph]').bind("click",function(e){var f=$(e.currentTarget);d.switch_graph(f.attr("graph"));console.log(f.attr("graph"))});this.textarea.bind("keyup",this.proxy(this.new_selection_hdl));this.el.find("#rows").click(this.proxy(this.rows_series_hdl));this.el.find("#cols").click(this.proxy(this.cols_series_hdl))},rows_series_hdl:function(){this.data.options.col_data_series=false;this.switch_graph(this.current_graph)},cols_series_hdl:function(){this.data.options.col_data_series=true;this.switch_graph(this.current_graph)},new_selection_hdl:function(d){var e=this.select_area();if(!e){return}if(!this.view){return}this.view.selected=e;this.data=new c(this.view.graph_selection());this.switch_graph(this.current_graph)},select_area:function(p){var r=this.textarea.val().trim();var l=r.match(this.regex_area);if(!l||l[0]!=r){return false}if(!this.view){return}var m=this.view.hot.countRows();var q=this.view.hot.countCols();var o,e=[],h;var n="a".charCodeAt(0),f="A".charCodeAt(0);var k="z".charCodeAt(0),d="Z".charCodeAt(0);var g=r.split(",");for(var j=0;j<g.length;++j){o=this.sregex.exec(g[j].trim());console.log({t:g,i:j});var h=o[1].charCodeAt(0);if(n<=h&&k>=h){h-=n}if(f<=h&&d>=h){h-=f}o[1]=h;h=o[3].charCodeAt(0);if(n<=h&&k>=h){h-=n}if(f<=h&&d>=h){h-=f}o[3]=h;o[2]=parseInt(o[2])-1;o[4]=parseInt(o[4])-1;e.push([o[2],o[1],o[4],o[3]])}this.view.select_area(false);for(var j=0;j<e.length;++j){this.view.select_area(e[j])}return e;console.log(e)},export_meta:function(){return helper.obj2str(this.meta)},save_chart_hdl:function(d){d.preventDefault();var e,f=$(d.currentTarget);console.log(f);if(!this.file){var g=prompt("file name: ");if(g==null){return}e=new File2({name:g,type:2})}else{e=this.file}e.data=this.export_meta();if(!e.save()){notification.show();notification.hide(5000,e.validate());return}this.file=e;notification.show('file saved. <a href="#files"> see folder</a>',true)},close_hdl:function(d){d.preventDefault();this.el.removeClass("active")},show:function(){console.log("show");this.meta=this.view.graph_selection();this.data=new c(this.meta);this.switch_graph(this.current_graph);this.textarea.val(this.meta.cells_area);this.el.addClass("active")}});return a}]);sukuApp.factory("ClassroomModel",["Model","ServerFileModel","Helper","RegisterService","PubSubService",function(f,e,c,d,b){var a=f.sub();a.configure("Classroom","name","school","responsible","files","selected","cannot_be_edited","sid");a.extend({url:function(g){if(g=="save"){return"../server/add-classroom"}if(g=="fetch"){return"../server/get-classrooms"}if(g=="destroy"){return"../server/del-classroom"}if(g=="fetch_one"){return"../server/get-classroom"}if(g=="share"){return"../server/share-classroom"}if(g=="activate"){return"../server/activate-classroom"}if(g=="add-file"){return"../server/add-file-classroom"}},sids:[],is_ssa:function(g){return(g=="name"||g=="school"||g=="sid")},Name:"classrooms",mustHaveNode:true});a.include(e.Helper);a.include({share_error:function(h,j,g){if(h==-1){j.reject({what:20,msg:"Unable to find "+g})}else{if(h==-3){j.reject({what:21,msg:"You already share this classroom with "+g})}else{j.reject({what:22,msg:"Error while sharing the test",code:h})}}},validate:function(){if(!this.name){return"the name is required to save the classroom"}this.name=c.present(this.name);if(this.school){this.school=c.present(this.school)}if(!this.responsible){this.responsible=d.user.name}this.responsible=c.present(this.responsible);if(this.id){var g=this.constructor.find(this.id).sid;if(this.constructor.sids[g]){this.cannot_be_edited=this.constructor.sids[g].cannot_be_edited}if(this.cannot_be_edited){return"No rights to edit this on the server. Contact  "+this.responsible+" for any modification "}if(g){this.constructor.sids[g]=this}}this.constructor.sids[this.sid]=this}});a.include(f.NodeHelper.Methods);f.all[a.Name]=a;b.conn.addHandler(f.NodeHelper.newItem,null,"message",null,null,b.service);return a}]);sukuApp.factory("ExcelColumnViewService",["Helper",function(Helper){var Column=Spine.Class.sub({init:function(){var args=arguments[0];if(!args){throw ("view, header must be specified")}$.extend(this,args);if(!this.name){throw ("name is required for each header")}this.index=this.index||this.name;this.mfield=this.mfield||this.index;this.col_index=this.view.columns.length;if(this.col_index==26){throw ({message:"maximum column reached",name:"max_column_exception"})}this.arcs=[];if(!this.items){this.items=[]}if(this.formula){this.item_strategy=new Column_fct_strategy({column:this})}else{this.item_strategy=new Column_item_strategy({column:this})}this.view.bind("cell-changed",this.proxy(this.view_changed));if(this.model){this.items=this.model.records}console.log(this.items)}});Column.include(Helper.Events);Column.include({item:function(row){return this.item_strategy.item(row)},type:function(){return this.item_strategy.type},set_data:function(row,data){this.item_strategy.set_data(row,data)},view_changed:function(evt,cell){if(cell.col!=this.col_index){return}this.set_data(cell.row,cell.data);this.trigger("changed",cell)},linked_column_changed:function(evt,cell){this.view.addOne(this.item(cell.row),cell.row,this.col_index)},depends_to:function(column){if(this.item_strategy.type=="item"){return false}for(var i=0;i<this.arcs.length;++i){if(this.arcs[i]==column.col_index){return true}}for(var i=0;i<this.arcs.length;++i){if(this.view.columns[this.arcs[i]].depends_to(column)){return true}}return false}});var Column_item_strategy=Spine.Class.sub({init:function(){var args=column=arguments[0];$.extend(this,args);this.type="item"}});Column_item_strategy.include({item:function(row){if(this.column.items[row]){return this.column.items[row]}else{var mfield=this.column.mfield;var item={};item[mfield]=null;this.column.items[row]=item}return this.column.items[row]},set_data:function(row,data){var item=this.item(row);item[this.column.mfield]=data}});var Column_fct_strategy=Spine.Class.sub({init:function(){var args=arguments[0];$.extend(this,args);this.type="fct";this.node=math.parse(this.column.formula);this.code=this.node.compile(math);this.vars=this.node.filter(function(node){return node.type=="SymbolNode"&&node.name.match(/[a-zA-Z]+[1-9]+/g)});var fcts=this.node.filter(function(node){return node.type=="FunctionNode"&&!math[node.name]});if(fcts.length){var msg="";for(var i=0;i<fcts.length;++i){msg+=fcts[i].name;if(i!=fcts.length-1){msg+=", "}}msg+=" unknown function(s)";throw ({name:"unknow params",message:msg})}this.cell0=[];var col,row,a="a".charCodeAt(0),A="A".charCodeAt(0);var z="z".charCodeAt(0),Z="Z".charCodeAt(0);var already={};for(var i=0;i<this.vars.length;++i){col=this.vars[i].name.match(/[a-zA-Z]+/)[0].charCodeAt(0);if(a<=col&&z>=col){col-=a}if(A<=col&&Z>=col){col-=A}row=parseInt(this.vars[i].name.match(/[1-9]+/)[0])-1;this.cell0.push({i:row,j:col});if(!already[col]){already[col]=true;this.column.arcs.push(col);if(!this.column.view.columns[col]){var msg=this.vars[i].name.match(/[a-zA-Z]+/)[0];msg="column "+msg+" not yet defined ";throw ({name:"unknow column",message:msg})}this.column.view.columns[col].bind("changed",this.column.proxy(this.column.linked_column_changed))}}console.log(this.column.view);for(var row=0,max=row<this.column.view.hot.countRows();row<max;++row){this.item(row)}}});Column_fct_strategy.include({item:function(row){var col_vars={};for(var i=0;i<this.vars.length;++i){col_vars[this.vars[i]]=this.column.view.data(row+this.cell0[i].i,this.cell0[i].j)}var mfield=this.column.mfield;if(this.column.items[row]){this.column.items[row][mfield]=this.code.eval(col_vars)}else{var item={};item[mfield]=this.code.eval(col_vars);this.column.items[row]=item}return this.column.items[row]},set_data:function(row,data){}});Column.ItemStrategy=Column_item_strategy;Column.FctStrategy=Column_fct_strategy;return Column}]);sukuApp.factory("ExcelViewService",["Helper","ExcelColumnViewService","ChartViewService",function(e,d,a){var f=[];var c={undo_hdl:function(h){h.preventDefault();this.hot.undo()},redo_hdl:function(h){h.preventDefault();this.hot.redo()},copy_hdl:function(h){h.preventDefault();this.buf=this.hot.getValue()},cut_hdl:function(j){j.preventDefault();this.buf=this.hot.getValue();var h;h=this.hot.getSelected();this.hot.setDataAtCell(h[0],h[1],null)},paste_hdl:function(j){j.preventDefault();var h;h=this.hot.getSelected();this.hot.setDataAtCell(h[0],h[1],this.buf)}};var b={add_graph_hdl:function(h){h.preventDefault();var j=this.graph_selection();console.log(this.chart);this.chart.show()},insert_col_hdl:function(h){h.preventDefault();console.log("insert_col_hdl")},insert_col_bind_dialog:function(h,k){console.log({id:h,col:k});if(h!=this.id){return}var r=k.split("&");var n={},q;for(var m=0;m<r.length;++m){q=r[m].split("=");n[q[0]]=q[1]}var o={view:this,name:n.title,items:[]};if(n["content-type"]=="2"){o.formula=n.formula}if(n["content-type"]=="3"){o.model=this.model;o.mfield=n.attr;for(var l=0,p=this.model.count();l<p;++l){o.items.push(this.model.records[l])}}this.add_column(o)},remove_col_hdl:function(j){j.preventDefault();var m=this.hot.getSelected(),l,h;if(m&&m.length){l=m[1];h=m[3]}for(var k=l;k<=h;++k){this.columns.remove(k)}console.log({min:l,max:h})},insert_row_hdl:function(j){j.preventDefault();var l=this.hot.getSelected(),k,h;if(l&&l.length){k=l[0];h=l[2]}else{h=this.hot.countRows()}this.hot.alter("insert_row",h+1)},remove_row_hdl:function(j){j.preventDefault();var m=this.hot.getSelected(),l,h;if(m&&m.length){l=m[0];h=m[2]}else{return}console.log({min:l,max:h});for(var k=l;k<=h;++k){this.hot.alter("remove_row",k)}}};var g=Spine.Class.sub({init:function(){var h=arguments[0];if(!h){throw ("id, headers must be specified")}var j=this;this.columns=[];this.columns.remove=function(n){console.log({what:"remove",index:n});if(!n){return}column=this.splice(n,1)[0];for(var p=n;p<this.length;++p){this[p].col_index=p}j.hot.alter("remove_col",n);var q;for(var p=0;p<this.length;++p){q=this[p];for(var m=0;m<q.arcs.length;++m){if(q.arcs[m]==n){q.item_strategy=new d.ItemStrategy({column:q});break}}}var o;for(var p=n+1;p<this.length;++p){if(this[p].type()=="item"){continue}o=this[p].item_strategy.cell0;for(var l=0;l<o.length;++l){if(o[l].j>=n){--o[l].j}}}for(var p=0;p<this.length;++p){q=this[p];for(var m=0;m<q.arcs.length;++m){if(q.arcs[m]>=n){--q.arcs[m]}}}};this.headers=h.headers;this.el=h.el;this.table=this.el.find(".excel-tab");if(this.el.attr("id")){f[this.el.attr("id")]=this;this.id=this.el.attr("id")}this.initialize()}});g.getViewById=function(h){return f[h]};g.include(b);g.include(c);g.include({initialize:function(){var k=[];for(var l=0;l<this.columns.length;++l){k.push(this.columns[l].name)}var m=this;var j=screen.availHeight-250-50;j=500;this.hot=new Handsontable(this.table[0],{data:[[]],colHeaders:function(n){return m.columns[n].name},outsideClickDeselects:false,rowHeaders:true,stretchH:"none",autoWrapRow:true,minSpareRows:0,afterRender:function(n){},manualRowResize:true,manualColumnResize:true,height:j,beforeKeyDown:this.proxy(this.before_key_down),afterRender:this.proxy(this.after_render),afterChange:this.proxy(this.after_change),beforeChange:this.proxy(this.before_change),afterOnCellMouseDown:this.proxy(this.myMultipleHS),afterSelectionEnd:this.proxy(this.after_selection_end)});this.selected=[];this.hot_table=$(this.hot.table);this.hot_table=this.table;this.bind_events();var m=this;this.hot.updateSettings({cells:function(o,n){if((m.model&&m.columns[n].model)&&m.columns[n].model.Name==m.model.Name){return{readOnly:true}}}});var h;for(var l=0;l<this.headers.length;++l){console.log(this.headers[l]);h=$.extend({view:this},this.headers[l]);console.log(h);this.columns.push(new d(h))}},adjust:function(){var h=$(window).height();var j=this.el.offset().top;this.hot.updateSettings({height:h-j-80})},bind_events:function(){this.adjust();$(window).bind("resize",this.proxy(this.adjust));this.top_menu=this.el.find(".top-menu:first");this.top_menu.find('[href="#edit-item"]').bind("click",this.proxy(this.edit_item_hdl));this.top_menu.find('[href="#del-item"]').bind("click",this.proxy(this.delete_item_hdl));this.top_menu.find('[href="#undo"]').bind("click",this.proxy(this.undo_hdl));this.top_menu.find('[href="#redo"]').bind("click",this.proxy(this.redo_hdl));this.top_menu.find('[href="#cut"]').bind("click",this.proxy(this.cut_hdl));this.top_menu.find('[href="#copy"]').bind("click",this.proxy(this.copy_hdl));this.top_menu.find('[href="#paste"]').bind("click",this.proxy(this.paste_hdl));this.top_menu.find('[href="#remove-row"]').bind("click",this.proxy(this.remove_row_hdl));this.top_menu.find('[href="#remove-col"]').bind("click",this.proxy(this.remove_col_hdl));this.top_menu.find('[href="#add-graph"]').bind("click",this.proxy(this.add_graph_hdl));this.top_menu.find('[href="#insert-row"]').bind("click",this.proxy(this.insert_row_hdl));this.top_menu.find('[href="#insert-col"]').bind("click",this.proxy(this.insert_col_hdl))},export_data:function(){var j="";for(var h=0;h<this.columns.length;++h){j+=this.columns[h].name;if(h!=this.columns.length-1){j+="\t"}}j+="\n";j+=this.hot.getCopyableData(0,0,this.hot.countRows()-2,this.hot.countCols()-1);return j},graph_selection:function(){var m={data:{},cells_area:"",col_headers:{},row_headers:{},empty_cols:{},empty_rows:{},min_row:this.hot.countRows()-1,max_row:0,min_col:this.hot.countCols()-1,max_col:0};if(!this.selected.length){return null}var l=this.selected;for(var h=0;h<l.length;++h){if(m.min_row>l[h][0]){m.min_row=l[h][0]}if(m.max_row<l[h][2]){m.max_row=l[h][2]}if(m.min_col>l[h][1]){m.min_col=l[h][1]}if(m.max_col<l[h][3]){m.max_col=l[h][3]}for(var n=l[h][0];n<=l[h][2];++n){for(var j=l[h][1];j<=l[h][3];++j){m.data[n+"-"+j]=this.hot.getDataAtCell(n,j);m.empty_rows[n]=true;m.empty_cols[j]=true}}m.cells_area+=e.pos2char(l[h][1])+(l[h][0]+1)+":"+e.pos2char(l[h][3])+(l[h][2]+1);if(h!=l.length-1){m.cells_area+=","}}for(var n=m.min_row;n<=m.max_row;++n){m.row_headers[n]=this.hot.getDataAtCell(n,m.min_col);m.empty_rows[n]=!m.empty_rows[n]}for(var j=m.min_col;j<=m.max_col;++j){m.col_headers[j]=this.columns[j].name;m.empty_cols[j]=!m.empty_cols[j]}return m},before_key_down:function(h){if((h.keyCode==13||(h.keyCode<=40&&h.keyCode>=37))&&!h.ctrlKey){this.select_area(false);this.selected=[]}},select_area:function(h){if(!h){this.hot_table.find("tbody .cell-area").removeClass("cell-area");return}for(var j=h[0];j<=h[2];++j){this.hot_table.find("tbody tr:eq("+j+")").each(function(){for(var k=h[1];k<=h[3];k++){$(this).find("td:eq("+k+")").addClass("cell-area")}})}},after_render:function(h){if(!this.selected){return}for(var j=0;j<this.selected.length;++j){this.select_area(this.selected[j])}},after_selection_end:function(l,m,j,k){var h=[l,m,j,k];this.selected.push(h);this.select_area(h)},myMultipleHS:function(j,k,l){if(!j.ctrlKey){this.selected=[];this.select_area(false);if(k.row==-1||k.col==-1){var h=this.hot.getSelected();this.after_selection_end(h[0],h[1],h[2],h[3])}}},before_change:function(r,q){if(!r){return}var o=r[0][0],m=r[0][1],n=r[0][3];var h=this.hot.getCellMeta(o,m);var k=this.columns[m];var p=k.model;if(p==this.model){return true}if(p&&h.model_id){var l=p.find(h.model_id);if(l){if(l[k.mfield]!=n){l[k.mfield]=n;console.log("after-change-save");if(l.validate()){return false}l.save()}}}},after_change:function(n,h){if(!n){return}var l=n[0][0],k=n[0][1],m=n[0][3];this.trigger("cell-changed",{row:l,col:k,data:m})},setModel:function(l){this.model=l;for(var m=0;m<this.columns.length;++m){if((l&&this.columns[m].model)&&this.columns[m].model.Name!=l.Name||this.columns[m].items){continue}for(var k=0,h=l.count();k<h;++k){this.columns[m].items.push(l.records[k])}}this.item_id2view_row={};this.addAll()},setItems:function(h){this.columns={};this.columns.length=0;for(var l=0;l<h[0].length;++l){this.hot.alter("insert_col");this.columns[l]={name:h[0][l]};++this.columns.length}for(var l=1;l<h.length;++l){for(var k=0;k<h[l].length;++k){this.hot.setDataAtCell(l,k,h[l][k])}}this.hot.alter("remove_row",0);console.timeEnd("set-items")},addAll:function(){console.log(this.columns.length);for(var h=0;h<this.columns.length;++h){for(var j=0;j<this.columns[h].items.length;++j){this.addOne(this.columns[h].item(j),j,h)}}this.hot.clearUndo()},data:function(k,h){return this.hot.getDataAtCell(k,h)},setData:function(k,h,l){this.hot.setDataAtCell(k,h,l)},addOne:function(l,m,h){if(h==undefined){var k=this.hot.countRows()-1;for(var j=0;j<this.columns.length;++j){this.hot.setDataAtCell(k,j,l[this.columns[j].mfield]);this.hot.setCellMeta(k,j,"model_id",l.id)}this.item_id2view_row[l.id]=k}else{this.hot.setDataAtCell(m,h,l[this.columns[h].mfield]);this.hot.setCellMeta(m,h,"model_id",l.id);if(h==0){this.item_id2view_row[l.id]=m}}},updateOne:function(k){var l=this.item_id2view_row[k.id];for(var j=0,h=this.columns.length;j<h;++j){if(this.columns[j].model!=this.model){continue}this.hot.setCellMeta(l,j,"key",false);this.hot.setDataAtCell(l,j,k[this.columns[j].mfield])}},removeOne:function(k){var l;for(var h=0,j=this.hot.countRows();h<j;++h){l=this.hot.getCellMeta(h,0);if(l.model_id==k.id){this.hot.alter("remove_row",h);return}}},add_column:function(l){var j;j=new d(l);this.columns.push(j);console.log("hide");this.hot_table.css("display","none");this.hot.alter("insert_col");for(var m=0,k=this.hot.countRows(),h=this.columns.length-1;m<k;++m){this.addOne(j.item(m),m,h)}this.hot_table.css("display","block");console.log("show")},html:function(){this.hot.render();return this.el}});g.include(e.Events);return g}]);sukuApp.factory("Helper",[function(){var a={};a.truncate=function(d,b){if(!d){return""}if(b<=3){return d.slice(0,b)}if(d.length>b){var c=d.slice(0,b);c=c.split("");c[b-3]=c[b-2]=c[b-1]=".";return a.present(c.join(""));console.log(c)}return a.present(d)};a.present=function(c){if(!c){return""}var b=/\+/g;return c.replace("%40","@").replace(/\+/g," ")};a.cr2br=function(c){if(!c){return""}var b=/\+/g;return c.replace(/\n/g,"<br/>")};a.id2hash_h=function(f,e){var d=f.split("-")[1];if(!d){return f}if(!e){e=5}var b="0";d=parseInt(d);for(var c=e;c>=0;--c){if(d<Math.pow(10,c)){b+="0"}else{b+=d;break}}return b};a.id2hash=function(f,e){var d=f.split("_");var b="";for(var c=0;c<d.length;++c){b+=a.id2hash_h(d[c],e);if(c!=d.length-1){b+="_"}}return b};a.hash2id=function(e){var b="";var d=e.split("_");for(var c=0;c<d.length;++c){b+="c-"+parseInt(d[c]);if(c!=d.length-1){b+="_"}}return b};a.obj2str=function(e){var f="{",c=0,d=0;for(var b in e){++c}for(var b in e){f+='"'+b+'":';if(typeof e[b]=="number"||typeof e[b]=="boolean"){f+=e[b]}else{if(typeof e[b]=="string"){f+='"'+e[b]+'"'}else{if(typeof e[b]=="object"){f+=a.obj2str(e[b])}}}if(++d!=c){f+=","}}f+="}";return f};a.email2jid=function(b){return b.replace("@","-")+"@localhost"};a.str2xcel=function(f){var d=f.split("\n"),e,c=[];for(var b=0;b<d.length;++b){e=d[b].split("\t");c.push(e)}return c};a.is_local_id=function(d){var c=d.split("-");if(c.length!=2||c[0]!="c"){return false}for(var b=0;b<c[1].length;++b){if(c[1][b]<"0"||c[1][b]>"9"){return false}}return true};a.is_eval_finished=function(b){console.log(localStorage.getItem("end"));if(localStorage.getItem("end")){return true}var e=1427368230845;var d=new Date().getTime();var c=d-e;if(c<0||c>b*86400000){localStorage.setItem("end",true);console.log(c/86400000);return true}return false};a.str2xcel=function(f){var d=f.split("\n"),e,c=[];for(var b=0;b<d.length;++b){e=d[b].split("\t");c.push(e)}return c};a.sexe_code=function(b){if(b=="Male"){return 1}if(b=="Female"){return 2}};a.mgp=function(b){var c=parseInt(b);grade=null;if(c>=0&&c<4){grade="F"}else{if(c>=4&&c<6){grade="D-"}else{if(c>=6&&c<8){grade="D+"}else{if(c>=8&&c<10){grade="C-"}else{if(c>=10&&c<12){grade="C+"}else{if(c>=12&&c<14){grade="B-"}else{if(c>=14&&c<16){grade="B+"}else{if(c>=16&&c<18){grade="A-"}else{if(c>=18&&c<=20){grade="A+"}}}}}}}}}return grade};math.mgp=a.mgp;a.success_fail=function(b){b=parseFloat(b);if(b<10){return"Fail"}else{return"Success"}};math.success_fail=a.success_fail;a.sexe_mark=function(b,c){var c=parseFloat(c);b=a.sexe_code(b);grade=null;if(b==1&&c>=10){grade="Male-Success"}else{if(b==1&&c<10){grade="Male-Fail"}else{if(b==2&&c>=10){grade="Female-Success"}else{if(b==2&&c<10){grade="Female-Fail"}}}}return grade};math.sexe_mark=a.sexe_mark;a.depend_to=function(c){for(var b=0;b<this.arcs.length;++b){if(this.arcs[b]==c.col_index){return true}}for(var b=0;b<this.arcs.length;++b){if(test_cols[this.arcs[b]].depends_to(c)){return true}}return false};test_cols=[{depends_to:a.depend_to,col_index:0,arcs:[1]},{depends_to:a.depend_to,col_index:1,arcs:[5]},{depends_to:a.depend_to,col_index:2,arcs:[4,3]},{depends_to:a.depend_to,col_index:3,arcs:[]},{depends_to:a.depend_to,col_index:4,arcs:[]},{depends_to:a.depend_to,col_index:5,arcs:[2]},{depends_to:a.depend_to,col_index:6,arcs:[2]}];a.alphabet=["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"];a.pos2char=function(b){return a.alphabet[b]};a.Events={bind:function(){if(!this.o){this.o=$({})}this.o.bind.apply(this.o,arguments)},trigger:function(){if(!this.o){this.o=$({})}this.o.trigger.apply(this.o,arguments)}};window.Helper=a;return a}]);sukuApp.factory("MarksTestModelFactory",["Model","ClassroomModel","TestModel","Helper","$q",function(f,d,b,c,a){var e={};e.elts=[];e.create=function(h){if(this.elts[h]){return this.elts[h]}var g=f.sub();g.configure("Mark-"+h,"value","student_id","sid");g.parent_id=h;this.elts[h]=g;g.test=b.find_by_sid(h);g.classroom=d.find_by_sid(g.test.classroom.sid);g.extend({url:function(j){if(j=="destroy"){return"../server/del-mark"}if(this.test.sid){if(j=="save"){return"../server/add-mark/"+this.test.sid}if(j=="fetch"){return"../server/get-marks/"+this.test.sid}}else{var k=b.find(this.test.id);if(k.sid){this.test=k;this.url(j)}else{return false}}},sids:[],stdids:[],is_ssa:function(j){return(j=="value"||j=="student_id")},Name:"marks-"+h});g.include({validate:function(){if(!this.student_id){return"the corresponding student is required"}if(this.id&&this.constructor.test.cannot_be_edited){return"No rights to edit this on the server. Contact the responsible of the test for any modification"}if(this.value){}this.constructor.stdids[this.student_id]=this}});f.all[g.Name]=g;return g};return e}]);sukuApp.factory("ModelLoaderService",["$q","ClassroomModel","TestModel","StudentsClassroomModelFactory","MarksTestModelFactory","AuthLoaderService","NotificationService",function(b,f,e,d,h,a,g){var c={};c.loadClassrooms=function(j){return a.load().then(function(){return f.fetch(j)})};c.loadTests=function(j){return a.load().then(function(){return e.fetch(j)})};c.loadClassroom=function(j,k){return a.load().then(function(){return f.fetch_one(j).then(function(){var l=d.create(j);return l.fetch()})})};c.loadTest=function(j,k){return a.load().then(function(){return e.fetch_one(j).then(function(){console.log(j,e.records);var l=e.find_by_sid(j);return c.loadClassroom(l.classroom.sid).then(function(){var m=h.create(j);return m.fetch()})})})};c.load=function(){console.log({f:f.isFetched});var j=b.defer();return f.fetch().then(function(){var k=f.count();f.each(function(m){console.log(m.id);var l=d.create(m.sid);l.fetch().then(function(){if(--k==0){j.resolve()}},function(){console.log("error",k);j.reject()})});return j.promise}).then(function(){e.fetch().then(function(){console.log(e.count());e.each(function(l){console.log(l.sid);var k=h.create(l.sid);k.fetch()})})},function(k){console.log("alerts",k);if(k.id==5){}if(k.status==400){}j.reject(k);return j.promise})};c.shareHandler=function(l){console.log(l);var k=$(l).find("body");if(!k){return true}k=JSON.parse(k);var j=k.sid;var m=k.what;if(!l||!m){return true}if(m=="tests"){c.loadTest(j)}else{if(m=="classrooms"){c.loadClassroom(j)}}return true};return c}]);sukuApp.factory("Model",["$q","$http","PubSubService","NotificationService",function(f,g,l,h){var d=Spine.Model;d.all={};var k={pupdate:function(n){var o,m;m=this.constructor.irecords;m[this.id].load(this.attributes());this.constructor.sort();o=m[this.id].clone();return o},pcreate:function(n){var o,m;this.id||(this.id=this.cid);m=this.dup(false);this.constructor.addRecord(m);this.constructor.sort();o=m.clone();return o},psave:function(o){var n,m;if(o==null){o={}}if(o.validate!==false){n=this.validate();if(n){this.trigger("error",n);return false}}m=this.isNew()?this.pcreate(o):this.pupdate(o);this.stripCloneAttrs();return m}};Local_save={};Local_save.lupdate=Spine.Model.prototype.update;Local_save.lsave=Spine.Model.prototype.save;Local_save.lcreate=Spine.Model.prototype.create;var b={to_json_str:function(){var m=this.constructor.attributes;var n="{";for(i=0;i<m.length;++i){n+='"'+m[i]+'": "'+this[m[i]]+'"';if(i<m.length-1){n+=","}}n+="}";return n},to_http_str:function(){var m=this.constructor.attributes;var n=[];for(i=0;i<m.length;++i){if(this.constructor.is_ssa(m[i])){n.push(m[i])}}var o="";for(i=0;i<n.length;++i){o+=n[i]+"="+this[n[i]];if(i<n.length-1){o+="&"}}return o}};var e={find_by_sid:function(m){console.log(this.sids,m,this.sids[m]);if(this.sids){return this.sids[m]}return this.findByAttributes("sid",m)}};var c={sdestroy:function(){var n=this;var m=this.constructor.url("destroy");var o=f.defer();g.get(m+"/"+this.sid).then(function(q){var p=q.data;p.status=parseInt(p.status);if(p.status!=0){o.reject(p)}code=parseInt(p.content);if(code!=1){o.reject({msg:"Unable to delete item"});return}if(!n.constructor.mustHaveNode){o.resolve();n.destroy();return}n.unsubscribe().then(function(){console.log("ok unsubscribe");o.resolve();n.destroy();return},function(r){o.reject(r)})},function(p){o.reject(p)});return o.promise}};var a={activate:function(){var n=this.constructor;var m=this;g.post(n.url("activate")+"/"+this.sid).then(function(){l.subscribe(n.Name+"-"+m.sid).then(function(){l.getItems(n.Name+"-"+m.sid)});console.log("ok")})},save:function(){var n=this.constructor.url("save");var o=this;var q="saving "+(this.name||this.code||"item");var n=this.sid?n+"/"+this.sid:n+"/0";var m=f.defer();if(this.validate()){console.log("lsave failed");m.reject({what:1,msg:this.validate()});return m.promise}var p=!this.sid;console.log(n,this);g.post(n,this).then(function(s){var t=s.data;t.status=parseInt(t.status);if(t.status!=0){o.destroy();m.reject({what:2,msg:"bad id"})}var r=t.content;console.log(r);o.sid=r;o.psave();if(o.constructor.mustHaveNode&&p){l.createNode(o.node()).then(function(){o.comments=l.subs[o.node()]=[];m.resolve(r)},function(){m.reject({what:13,msg:"unable to create node"})})}else{m.resolve(r)}},function(r){m.reject(r)});return m.promise}};var j={isFetched:false,isLoading:false,fetch:function(p){var n=this.url("fetch");var o=this;var m=f.defer();if(this.isLoading){m.reject({id:5,msg:"is already fetching"});return m.promise}this.isLoading=true;if(this.isFetched&&!p){m.resolve();this.isLoading=false;return m.promise}console.log(n);g.get(n).then(function(t){var v=t.data;v.status=parseInt(v.status);if(v.status!=0){m.reject(v);o.isFetched=false;o.isLoading=false;return}var r=v.content;var w;for(var s=0,q=r.length;s<q;++s){w=r[s].active;console.log(r[s]);var u=new o(r[s]);if(!u.psave()){continue}if(o.mustHaveNode){u.comments=l.subs[u.node()]=[];console.log(w);if(w=="2"){u.activate()}}}m.resolve(r);o.isFetched=true;o.isLoading=false},function(q){o.isFetched=false;o.isLoading=false;m.reject(q)});return m.promise},fetch_one:function(m,r){var o=this.url("fetch_one")+"/"+m;var q=this;var n=f.defer();console.log("fetch-one",o);if(!r){var p=q.find_by_sid(m);if(p){n.resolve(p);return n.promise}}g.get(o).then(function(v){var t=v.data;console.log(t);t.status=parseInt(t.status);if(t.status!=0){n.reject(t);return}var s=t.content;console.log(s);var u=s.active;s=new q(s);s.psave();if(q.mustHaveNode){s.comments=l.subs[s.node()]=[];console.log(u);if(u=="2"){s.activate()}}n.resolve(s)},function(s){n.reject(s)});return n.promise}};d.NodeHelper={newItem:function(m){if(!m.what){return}var n=m.what.split(" ");if(n.indexOf()){}return true}};d.NodeHelper.Methods={olds:[],share:function(m){var n=this;var o=f.defer();g.post(n.constructor.url("share")+"/"+n.sid,{email:m}).then(function(s){var r=s.data;r.status=parseInt(r.status);if(r.status!=0){o.reject(r);return}var q=parseInt(r.content);if(q==1){var p={type:"info",link:n.constructor.Name+"/"+n.sid,msg:"shared "+(n.name||n.code)+" ("+n.constructor.Name+") with you"};h.notify(Helper.email2jid(m),p);o.resolve(q)}else{n.share_error(q,o,m)}});return o.promise},node:function(){return this.constructor.Name+"-"+this.sid},publish:function(m){return l.publish(this.node(),m)},unsubscribe:function(){return l.unsubscribe(this.node())},getOldComments:function(){var m=this;var n=f.defer();if(m.loadedComments){n.resolve();return n.promise}l.getItems(m.node()).then(function(o){$(o).find("body").each(function(){var p=JSON.parse($(this).text());m.olds.push(p)});m.loadedComments=true;n.resolve()},function(o){console.log(o);n.reject(o)});return n.promise}};h.conn.addHandler(d.new_item,null,"message",null,null,l.service);d.include(b);d.include(Local_save);d.include(k);d.extend(e);d.extend(j);d.include(a);d.include(c);window.model=d;return d}]);sukuApp.factory("NotificationService",["Strophe","PubSubService","RegisterService","Helper","$q","$rootScope",function(g,d,e,c,b,a){var f={olds:[],items:[]};f.conn=d.conn;f.notify=function(h,j){h=g.getNodeFromJid(h);console.log("users-"+h,j);return d.publish("users-"+h,j)};f.init=function(h){f.node="users-"+g.getNodeFromJid(h);console.log(f.node);d.subs[f.node]=f.items};f.getNotifications=function(h,k){if(!h){h=5}var j=b.defer();if(!f.node){j.reject();return j.promise}if(f.loadedComments&&!k){j.resolve();return j.promise}console.log(f.node);d.getItems(f.node,h).then(function(l){$(l).find("item").each(function(){var o=JSON.parse($(this).find("body").text());o.jiid=$(this).attr("id");var m=-1;for(var n=0;n<f.olds.length;++n){if(f.olds[n].jiid==o.jiid){m=n;break}}console.log(m,o);if(m>-1){f.olds[m]=o}else{f.olds.unshift(o)}});f.loadedComments=true;j.resolve(l)},function(l){console.log(l);j.reject(l)});return j.promise};f.readNotifications=function(){var m=b.defer();if(f.olds.length==0){m.resolve()}var n=[],h=[];for(var j=0,l=f.olds;j<f.olds.length;++j){var k=f.olds[j];k.type="read";console.log(k);d.publish(f.node,k).then(function(o){h.push(o);if(--l==0){if(n.length==0){m.resolve(h)}else{m.reject(n)}}},function(o){o={msg:o,index:l};n.push(o);if(--l==0){m.reject(erros)}else{return o}})}};window.notif=f;return f}]);sukuApp.factory("PubSubService",["Strophe","RegisterService","$q","$rootScope",function(f,e,b,a){var d={NS_DATA_FORMS:"jabber:x:data",NS_PUBSUB:"http://jabber.org/protocol/pubsub",NS_PUBSUB_OWNER:"http://jabber.org/protocol/pubsub#owner",NS_PUBSUB_ERRORS:"http://jabber.org/protocol/pubsub#errors",NS_PUBSUB_NODE_CONFIG:"http://jabber.org/protocol/pubsub#node_config",items:[],subs:{},handlers:[],resource:"web"};d.conn=e.conn;d.service="pubsub."+f.ServerAddr;d.sendIQq=function(g){var h=b.defer();d.conn.sendIQ(g,function(j){h.resolve(j)},function(j){h.reject(j)});return h.promise};d.createNode=function(g){var h=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("create",{node:g}).up().c("configure").c("x",{xmlns:d.NS_DATA_FORMS,type:"submit"}).c("field",{"var":"FORM_TYPE"}).c("value").t(d.NS_PUBSUB_NODE_CONFIG).up().up().c("field",{"var":"pubsub#send_last_published_item"}).c("value").t("never").up().up().c("field",{"var":"pubsub#publish_model"}).c("value").t("open").up().up().c("field",{"var":"pubsub#expire_time"}).c("value").t("31536000").up().up().c("field",{"var":"pubsub#max_items"}).c("value").t("1000");return d.sendIQq(h).then(function(){return d.subscribe(g)})};d.deleteNode=function(g){var h=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB_OWNER}).c("delete",{node:g});return d.sendIQq(h)};d.configureNode=function(g){};d.publish=function(h,g){if(!g.jiid){g.from={name:e.user.name,jid:e.user.jid,img:e.user.img,schools:e.user.schools,creation:e.user.creation}}g.date=new Date();if(!g.what){g.what="comment"}var j;if(g.jiid){j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("publish",{node:h}).c("item",{id:g.jiid}).c("entry",{xmlns:"http://www.w3.org/2005/Atom"}).c("body").t(JSON.stringify(g))}else{j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("publish",{node:h}).c("item").c("entry",{xmlns:"http://www.w3.org/2005/Atom"}).c("body").t(JSON.stringify(g))}return d.sendIQq(j)};d.deleteItem=function(h,g){};d.getItems=function(h,g){var j;if(g){j=$iq({to:d.service,type:"get"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("items",{node:h,max_items:g})}else{j=$iq({to:d.service,type:"get"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("items",{node:h})}return d.sendIQq(j)};d.subscribe=function(h){if(d.resource&&f.getResourceFromJid(d.conn.jid)!=d.resource){var g=f.getBareJidFromJid(d.conn.jid)+"/"+d.resource;var j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("subscribe",{node:h,jid:g});d.sendIQq(j)}var j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("subscribe",{node:h,jid:d.conn.jid});return d.sendIQq(j)};d.unsubscribe=function(h){if(d.resource&&f.getResourceFromJid(d.conn.jid)!=d.resource){var g=f.getBareJidFromJid(d.conn.jid)+"/"+d.resource;var j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("unsubscribe",{node:h,jid:g});d.sendIQq(j)}var j=$iq({to:d.service,type:"set"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("unsubscribe",{node:h,jid:d.conn.jid});return d.sendIQq(j)};d.getSubscriptions=function(g){var h=$iq({to:d.service,type:"get"}).c("pubsub",{xmlns:d.NS_PUBSUB_OWNER}).c("subscriptions",{node:g});return d.sendIQq(h)};d.getSubscriptionConfig=function(g){var h=$iq({to:d.service,type:"get"}).c("pubsub",{xmlns:d.NS_PUBSUB}).c("options",{node:g,jid:f.getBareJidFromJid(d.conn.jid)});return d.sendIQq(h)};d.addHandler=function(g){d.handlers.push(g)};d.new_item=function(k){console.log(k);var h=$(k).find("body").text();var g=$(k).attr("id");var j=$(k).find("items").attr("node");if(!h){return true}h=JSON.parse(h);h.jiid=g;a.$apply(function(){c(h,j)});return true};d.conn.addHandler(d.new_item,null,"message",null,null,d.service);var c=function(g,h){if(!d.subs[h]){d.subs[h]=[]}d.subs[h].unshift(g);d.items.unshift(g);return true};window.pubsub=d;return d}]);sukuApp.factory("RegisterService",["Strophe","$q",function(c,a){var b={conn:null};b.conn=new c.Connection(c.BOSH_SERVICE);b.register=function(e){console.log(e);var f=a.defer();if(!c.getNodeFromJid(e.jid)){e.jid+="@"+c.ServerAddr+"/web"}var g=function(d){if(d===c.Status.REGISTER){b.conn.register.fields.username=c.getNodeFromJid(e.jid);b.conn.register.fields.resource="web";b.conn.register.fields.password=e.pwd;b.conn.register.submit();console.log("register")}else{if(d===c.Status.REGISTERED){console.log("registered");b.conn.authenticate()}else{if(d===c.Status.CONNECTED){b.user=e;f.resolve()}else{if(d===c.Status.CONNECTING||d===c.Status.AUTHENTICATING){}else{var h;if(d===c.Status.CONFLICT){h="This address is already taken"}else{if(d===c.Status.REGIFAIL){h="Registration failed"}else{if(d===c.Status.NOTACCEPTABLE){h="Fields not acceptable"}else{h="ERROR"}}}h+=". Unable to register your account";f.reject({what:10,msg:h})}}}}};b.conn.register.connect(c.ServerAddr,g);return f.promise};b.connect=function(e){if(!c.getNodeFromJid(e.jid)){e.jid+="@"+c.ServerAddr+"/web"}var f=a.defer();console.log(e);console.log(c.Status);var g=function(d){console.log(d);if(d===c.Status.CONNECTED){b.user=e;console.log(d,"connected");f.resolve()}else{if(d===c.Status.CONNECTING||d===c.Status.AUTHENTICATING){console.log(d,"connecting")}else{console.log(d);var h;if(d===c.Status.CONNFAIL){h="Connection Error"}else{h="ERROR"}console.log(d,h);f.reject({what:11,msg:h})}}};b.conn.connect(e.jid,e.pwd,g);return f.promise};b.disconnect=function(){var e=a.defer();var f=function(d){if(d===c.Status.DISCONNECTED){console.log("disconnected");e.resolve()}else{if(d===c.Status.DISCONNECTING){}else{e.reject()}}};b.conn.disconnect(f);return e.promise};return b}]);sukuApp.factory("ServerFileModel",["Model","Helper","$rootScope","$q","$http",function(e,d,a,c,f){var b=e.sub();b.configure("Server_File","file","src","alt","type","sid");b.extend({url:function(g){if(g=="save"){return"../server/add-server-file"}},loading:false,points:""});b.include({validate:function(){if(!this.type){return"type is mandatory"}},save:function(){var h=this.constructor.url("save")+"/"+this.type;var g=c.defer();a.$apply(function(){b.loading=true});$.upload(h,this.file,{upload:{progress:function(){a.$apply(function(){b.points+=".";console.log("p",b.loading)})}},success:function(j){a.$apply(function(){b.loading=false;b.points=""});g.resolve(j)},error:function(j){a.$apply(function(){b.points="";b.loading=false});g.reject(j)}});return g.promise}});b.Helper={addFile:function(g){var j=c.defer();var h=this;var g=new b({file:g,type:0});g.psave();g.save().then(function(k){self.working=false;if(k=="0"){j.reject({msg:"Error while saving the file. Check that the extension and the size are correct"});return}console.log(k);f.post(h.constructor.url("add-file")+"/"+h.sid,{file:k}).then(function(l){console.log(l.data);l=parseInt(l.data);if(l!=1){j.reject({msg:"Error while adding the file"});return}j.resolve();h.files.push(k);console.log(h)},function(){j.reject({msg:"Error while adding the file"})})},function(k){j.reject({msg:"Error while adding the file"})});return j.promise}};return b}]);sukuApp.factory("Strophe",[function(){var a=Strophe;a.BOSH_SERVICE="http://localhost:5280/http-bind";a.ServerAddr="localhost";return a}]);sukuApp.factory("StudentsClassroomModelFactory",["Model","ClassroomModel","Helper","$http","$q",function(e,d,c,f,a){var b={};b.elts=[];b.create=function(h){if(this.elts[h]){return this.elts[h]}var g=e.sub();g.configure("Student-"+h,"name","email","phone","sexe","sid","sexe_code","images_str","img");g.parent_id=h;g.classroom_id=h;this.elts[h]=g;g.classroom=d.find_by_sid(h);console.log(g.classroom,h);g.extend({url:function(k){if(k=="destroy"){return"../server/del-student"}if(this.classroom.sid){if(k=="save"){return"../server/add-student/"+this.classroom.sid}if(k=="fetch"){return"../server/get-students/"+this.classroom.sid}if(k=="add-std-from-file"){return"../server/create-std-from-file/"+this.classroom.sid}}else{var j=d.find_by_sid(this.classroom.id);if(j.sid){this.classroom=j;this.url(k)}else{return false}}},import_students_from_file:function(l){var j=a.defer();var k=this;f.get(this.url("add-std-from-file")+"/"+l).then(function(r){var q=r.data;q.status=parseInt(q.status);if(q.status!=0){console.log(q.content);j.reject({msg:"unable to add the students. Check you have the right permissions"});return}var n=q.content;for(var o=0,m=n.length;o<m;++o){var p=new k(n[o]);p.psave()}j.resolve()});return j.promise},sids:[],is_ssa:function(j){return(j=="name"||j=="email"||j=="sexe"||j=="images_str")},is_isa:function(j){return(j=="name"||j=="email"||j=="phone"||j=="sexe_code")},Name:"students-"+h,col_index:[]});g.include({validate:function(){if(!this.name){return"name is required to save the student"}if(this.id&&this.constructor.classroom.cannot_be_edited){return"No rights to edit this on the server. Contact the owner of the classroom for any modification"}this.name=c.present(this.name);this.email=c.present(this.email);if(this.sexe=="1"){this.sexe_code="Male"}else{if(this.sexe=="2"){this.sexe_code="Female"}}if(this.images_str){this.img=this.images_str.split(";")[0]}else{this.img="imgs/avatar-default.png"}this.constructor.sids[this.sid]=this}});e.all[g.Name]=g;return g};window.StudentsFactory=b;return b}]);sukuApp.factory("TestModel",["Model","Helper",function(c,a){var b=c.sub();b.configure("Test","code","date","subject","classroom","responsible","files","cannot_be_edited","selected","sid","classroom_name");b.extend({url:function(d){if(d=="save"){return"../server/add-test"}if(d=="fetch"){return"../server/get-tests"}if(d=="destroy"){return"../server/del-test"}if(d=="fetch_one"){return"../server/get-test"}if(d=="share"){return"../server/share-test"}if(d=="activate"){return"../server/activate-test"}},sids:[],is_ssa:function(d){return(d=="code"||d=="subject"||d=="date"||d=="classroom")},Name:"tests",mustHaveNode:true});b.include({share_error:function(f,g,e){if(f==-1){g.reject({what:20,msg:"Unable to find "+e})}else{if(f==-3){g.reject({what:21,msg:"You already share this classroom with "+e})}else{if(f==-2){g.reject({what:22,msg:"You need to share the classroom "+that.classroom_name+" before you can share this test ",code:f})}else{g.reject({what:23,msg:"Error while sharing the test",code:f})}}}},validate:function(){if(!(this.code&&this.classroom.sid)){return"code and classroom are required to save the test"}if(this.id&&this.cannot_be_edited){return"No rights to edit this on the server. Contact the owner of the classroom for any modification"}this.code=a.present(this.code);this.subject=a.present(this.subject);this.classroom_name=a.present(this.classroom.name);if(!this.responsible){this.responsible="stanley"}this.responsible=a.present(this.responsible);if(this.id){var d=this.constructor.find(this.id).sid;if(this.constructor.sids[d]){this.cannot_be_edited=this.constructor.sids[d].cannot_be_edited}if(this.cannot_be_edited){return"No rights to edit this on the server contact  "+this.responsible+" for any modification "}this.constructor.sids[d]=this}else{this.constructor.sids[this.sid]=this}}});b.include(c.NodeHelper.Methods);c.all[b.Name]=b;return b}]);sukuApp.factory("TranslateService",[function(){var a={lang:"en",elts:{}};a.lang="fr";a.elts.Classrooms={en:"Classrooms",fr:"Classes"};a.elts.Tests={en:"Tests",fr:"Tests"};a.elts.Colleagues={en:"Colleagues",fr:"Collegues"};a.elts["All classrooms"]={en:"All classrooms",fr:"Toutes les classes"};a.elts["All tests"]={en:"All tests",fr:"Tous les tests"};a.elts["Invite a colleague on sukull"]={en:"Invite a colleague on sukull",fr:"Inviter un colleague sur sukull"};a.elts.Profile={en:"Profile",fr:"Profil"};a.elts.Settings={en:"Settings",fr:"Parametres"};a.elts.Logout={en:"Logout",fr:"Deconnexion"};a.elts.Open={en:"Open",fr:"Ouvrir"};a.elts.Edit={en:"Edit",fr:"Modifier"};a.elts.Delete={en:"Delete",fr:"Supprimer"};a.elts["Your are not authenticated or your session has ended"]={en:"Your are not authenticated or your session has ended",fr:"Vous n'est pas connecte, ou votre session est terminee"};a.elts.Close={en:"Close",fr:"Fermer"};a.elts["Sign in"]={en:"Sign in",fr:"Se connecter"};a.elts["Chart Editor"]={en:"Chart Editor",fr:"Editeur Graphique"};a.elts["Data range"]={en:"Data range",fr:"Domaine"};a.elts["Graphic type"]={en:"Graphic type",fr:"Type de Graphique"};a.elts.Column={en:"Column",fr:"Colonne"},a.elts.Line={en:"Line",fr:"Ligne"},a.elts["Polar-Area"]={en:"Polar-Area",fr:"Polar-Area"};a.elts.Radar={en:"Radar",fr:"Radar"};a.elts["Pie, Doughnut"]={en:"Pie, Doughnut",fr:"Pie, Doughnut"};a.elts["Data series in rows"]={en:"Data series in rows",fr:"Series en ligne"};a.elts["Data series in columns"]={en:"Data series in columns",fr:"Series en colonnes"};a.elts.Properties={en:"Properties",fr:"Proprietes"};a.elts.Effectif={en:"Effectif",fr:"Effectif"};a.elts.Male={en:"Male",fr:"Homme"};a.elts.Female={en:"Female",fr:"Femme"};a.elts.Attachments={en:"Attachments",fr:"Fichies attaches"};a.elts["Attach a file"]={en:"Attach a file",fr:"Attacher un fichier"};a.elts.Activity={en:"Activity",fr:"Activite"};a.elts.comment={en:"comment",fr:"commentaire"};a.elts.Comment={en:"Comment",fr:"Commentez"};a.elts.name={en:"name",fr:"nom"};a.elts.sexe={en:"sexe",fr:"sexe"};a.elts.Male={en:"Male",fr:"Homme"};a.elts.Female={en:"Female",fr:"Femme"};a.elts.Success={en:"Success",fr:"Succes"};a.elts.Fail={en:"Fail",fr:"Echec"};a.elts.result={en:"result",fr:"resultat"};a.elts["sexe-result"]={en:"sexe-result",fr:"sexe-resultat"};a.elts.appreciation={en:"appreciation",fr:"appreciation"};a.elts["Male-Success"]={en:"Male-Success",fr:"Homme-Succes"};a.elts["Female-Success"]={en:"Female-Success",fr:"Femme-Succes"};a.elts["Male-Fail"]={en:"Male-Fail",fr:"Homme-Echec"};a.elts["Female-Fail"]={en:"Female-Fail",fr:"Femme-Echec"};a.elts.Undo={en:"Undo",fr:"Annuler"};a.elts.Redo={en:"Redo",fr:"Re-Annuler"};a.elts.Cut={en:"Cut",fr:"Couper"};a.elts.Copy={en:"Copy",fr:"Copier"};a.elts.Paste={en:"Paste",fr:"Coller"};a.elts["Remove row"]={en:"Remove row",fr:"Supprimer ligne"};a.elts["Remove column"]={en:"Remove column",fr:"Supprimer colonne"};a.elts["Insert row"]={en:"Insert row",fr:"Inserer ligne"};a.elts["Insert column"]={en:"Insert column",fr:"Inserer colonne"};a.elts["Insert graphic"]={en:"Insert graphic",fr:"Inserer un graphique"};a.elts.Editx={en:"Edit",fr:"Edition"};a.elts.Insert={en:"Insert",fr:"Insertion"};a.elts["Upload the text file"]={en:"Upload the text file",fr:"Uploader le fichier texte"};a.elts["You must import the students from a text file (.txt or .text)"]={en:"You must import the students from a text file (.txt or .text)",fr:"Importez les eleves a partir d' fichier texte (.txt or .text)"};a.elts["Each line in the file must contain the name of one student"]={en:"Each line in the file must contain the name of one student",fr:"Chaque line du fichier devra contenir le nom d'un eleve"};a.elts["If your student file is not a text file (pdf, excel, word, ...)"]={en:"If your student file is not a text file (pdf, excel, word, ...)",fr:"Si votre fichier n'est pas un fichier text (pdf, excel, word, ...)"};a.elts["open your text editor (notepad, bloc note, emacs ...)"]={en:"open your text editor (notepad, bloc note, emacs ...)",fr:"ouverz votre editeur de texte (notepad, bloc note, emacs ...)"};a.elts["copy the students' names in that file, each name on it's own line and save the file with the extension .txt or .text"]={en:"copy the students' name in that file, each name on it's own line and save the file with the extension .txt or .text",fr:"entrez le nom des eleves, chaque nom sur une sa ligne, et sauvegardez le fichier avec l'extension .txt or .text"};a.elts["Then import it via this assistant."]={en:"Then import it via this assistant.",fr:"Ensuite, importez le fichier via l'assistant"};a.elts["The other students' information (email, phone ...) must be filled later"]={en:"The other students' information (email, sexe ...) must be filled later",fr:"Les autres informations (email, sexe ...) seront remplies plus tard"};a.elts["The imported students will be added to students already present in the classroom before"]={en:"The imported students will be added to students already present in the classroom before",fr:"Les nouveaux eleves seront ajoutes a ceux precedemment presents dans la classe"};a.elts.Send={en:"Send",fr:"Envoyer"};a.elts["Enter your colleague's email"]={en:"Enter your colleague's email",fr:"Entrez l'email de votre collegue"};a.elts["You may want to share some of your classroom with him"]={en:"You may want to share some of your classroom with him",fr:"Vous pouvez partager certaines de vos classes avec lui"};a.elts.Invite={en:"Invite",fr:"Inviter"};a.elts.Name={en:"Name",fr:"Nom"};a.elts.School={en:"School",fr:"Etablissement"};a.elts.Classroom={en:"Classroom",fr:"classe"};a.elts["classroom name"]={en:"classroom name",fr:"nom classe"};a.elts["school name"]={en:"school name",fr:"nom etablissement"};a.elts.Save={en:"Save",fr:"Sauvegarder"};a.elts["New Classroom"]={en:"New Classroom",fr:"Nouvelle Classe"};a.elts["New Test"]={en:"New Test",fr:"Nouveau Test"};a.elts["New Student"]={en:"New Student",fr:"Nouvel Eleve"};a.elts["Import Students"]={en:"Import Students",fr:"Importer Eleves"};a.elts["Share Classroom"]={en:"Share Classroom",fr:"Partager la Classe"};a.elts.Details={en:"Details",fr:"Details"};a.elts.Code={en:"Code",fr:"Code"};a.elts.Date={en:"Date",fr:"Date"};a.elts.Subject={en:"Subject",fr:"Matiere"};a.elts.Name={en:"Name",fr:"Nom"};a.elts.Email={en:"Email",fr:"Email"};a.elts.Sexe={en:"Sexe",fr:"Sexe"};a.elts["Notify Students"]={en:"Notify Students",fr:"Notifier les Eleves"};a.elts["Share Test"]={en:"Share Test",fr:"Partager le Test"};a.tr=function(h,g,f,e,d,c,b){if(a.elts[h]){return a.elts[h][a.lang]}return h};return a}]);sukuApp.factory("XmppService",[function(){var a=Strophe;a.BOSH_SERVICE="http://localhost:5280/http-bind";return a}]);